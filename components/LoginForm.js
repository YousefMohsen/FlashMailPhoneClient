import React from 'react';
import { ScrollView, StyleSheet, View, TextInput, Platform, TouchableOpacity, Dimensions, AsyncStorage } from 'react-native';
import { Container, Header, Content, Button, Icon ,Text, Item, Input, Label } from 'native-base';
import { ExpoLinksView } from '@expo/samples';
import RequestHandler from '../data/RequestHandler'
import Colors from '../styles/Colors'
import PushTokenGenerator from '../data/PushTokenGenerator'

/**
LoginForm component. Conatins a textinput for email-login and submit button. 
Used in LoginScreen.js

 */
export default class LoginForm extends React.Component {

  constructor(props) {
    super(props);

    this.state = {
      mail: "",
    }

    this._saveUserInfoLocally = this._saveUserInfoLocally.bind(this);
    this._handleSignIn = this._handleSignIn.bind(this);
  }

/**
 * 
 * @param {String} input - newest input from keyboard
 */
  _handleMailChange(input) {
    this.setState({ mail: input });
  }
/**
 * sends mail and a pushToken(generated by Expo) to FlashMailServer. 
 * Shows app content if login success. Shows error if not.
 */
  _handleSignIn = async() =>{
 const  mail  = this.state.mail;
 const pushToken = await PushTokenGenerator.registerForPushNotificationsAsync();
 console.log("pushToken",pushToken)
 try{
    let user = await  RequestHandler.handleSignIn(mail,pushToken);
    this._saveUserInfoLocally(user);
//show content if server comunication is made succefully
    if(user){this.props.showAppContent();} 
    else{throw 'No user found';}
    console.log("user",user)
    
 }catch(er){
     alert("Wrong email")
console.log(er)

 }


  }

/**
 * Saves user to local cache. 
 * @param {User} - userobject retrived from server when login successful
 */
  _saveUserInfoLocally = async (user) => {
    await AsyncStorage.setItem('@UserStore:info', JSON.stringify(user));

  }



  render() {
    return (
      <View style={styles.container}>



     
        
          <View style={styles.btnWrapper} >
          <Item  >
          
          <Input 
          placeholder="Type your email"
          value={this.state.mail}
          onChangeText={this._handleMailChange.bind(this)}
          style={{color:Colors.secondaryColor}}
          />
        </Item>
          </View>
          <View style={styles.btnWrapper} >
        
          <Button iconLeft full style={{backgroundColor:Colors.secondaryColor}} onPress={this._handleSignIn}>
          <Icon name='log-out' />
          <Text>Log in</Text>
        </Button>
        </View>
        

     

      </View>
    );
  }
}


const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.primaryColor,
    justifyContent: 'center',
    alignItems: 'center',

  },
  textFieldShort: {
    borderBottomWidth: 1,
    borderColor: Colors.secondaryColor,
    padding: 5,
    marginBottom: 2,
    color: Colors.secondaryColor,
    fontSize: 18,
    width: '80%'



  },
  loginButton: {
    textAlign: 'center',
    fontSize: 18,
    color: 'white',

    
    
  },

  btnWrapper:{
    marginRight:40,
    marginLeft:40,
    marginTop:30,
    backgroundColor: 'white',
    width: '70%'
    
  }
 




});
